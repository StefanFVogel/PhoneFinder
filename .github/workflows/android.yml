name: Android CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses || true

    - name: Install SDK components
      run: sdkmanager "platforms;android-34" "build-tools;34.0.0"

    - name: Decode Debug Keystore
      env:
        DEBUG_KEYSTORE_BASE64: ${{ secrets.DEBUG_KEYSTORE_BASE64 }}
      run: |
        echo "$DEBUG_KEYSTORE_BASE64" | base64 -d > app/debug.keystore

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: |
        ./gradlew assembleDebug \
          -Pandroid.injected.signing.store.file=$PWD/app/debug.keystore \
          -Pandroid.injected.signing.store.password=android \
          -Pandroid.injected.signing.key.alias=androiddebugkey \
          -Pandroid.injected.signing.key.password=android \
          --stacktrace

    - name: Decode Release Keystore
      env:
        RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
      run: |
        if [ -n "$RELEASE_KEYSTORE_BASE64" ]; then
          echo "$RELEASE_KEYSTORE_BASE64" | base64 -d > app/release.keystore
          echo "HAVE_RELEASE_KEY=true" >> $GITHUB_ENV
        fi

    - name: Build Release APK
      if: env.HAVE_RELEASE_KEY == 'true'
      env:
        RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
        RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
      run: |
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$PWD/app/release.keystore \
          -Pandroid.injected.signing.store.password=$RELEASE_STORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$RELEASE_KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$RELEASE_KEY_PASSWORD \
          --stacktrace

    - name: Build Release AAB (App Bundle)
      if: env.HAVE_RELEASE_KEY == 'true'
      env:
        RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
        RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
        RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
      run: |
        ./gradlew bundleRelease \
          -Pandroid.injected.signing.store.file=$PWD/app/release.keystore \
          -Pandroid.injected.signing.store.password=$RELEASE_STORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$RELEASE_KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$RELEASE_KEY_PASSWORD \
          --stacktrace

    - name: List build outputs
      run: |
        echo "=== APK files ==="
        find app/build/outputs/apk -name "*.apk" -ls 2>/dev/null || true
        echo "=== AAB files ==="
        find app/build/outputs/bundle -name "*.aab" -ls 2>/dev/null || true

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30

    - name: Upload Release APK
      if: env.HAVE_RELEASE_KEY == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: Upload Release AAB (for Play Store)
      if: env.HAVE_RELEASE_KEY == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-aab
        path: app/build/outputs/bundle/release/*.aab
        retention-days: 90

    # === GOOGLE DRIVE UPLOAD ===
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Google Dependencies
      run: pip install google-api-python-client google-auth

    - name: Write credentials file
      env:
        CREDS: ${{ secrets.GDRIVE_CREDENTIALS }}
      run: |
        # Try base64 decode first, otherwise write as-is
        if echo "$CREDS" | base64 -d > /tmp/gdrive-creds.json 2>/dev/null; then
          echo "Decoded base64 credentials"
        else
          echo "$CREDS" > /tmp/gdrive-creds.json
          echo "Wrote raw credentials"
        fi
        # Verify it's valid JSON
        python3 -c "import json; json.load(open('/tmp/gdrive-creds.json'))" && echo "Valid JSON ✓" || echo "Invalid JSON!"

    - name: Upload Debug APK to Google Drive
      id: gdrive_upload
      continue-on-error: true
      env:
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        python3 << 'PYEOF' 2>&1 | tee /tmp/gdrive-debug.log
        import os, json, sys, time, traceback
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from googleapiclient.errors import HttpError
        from google.oauth2 import service_account

        def upload_to_drive(retries=3):
            # Load credentials from file
            print("=== GOOGLE DRIVE DEBUG ===")
            
            try:
                with open('/tmp/gdrive-creds.json', 'r') as f:
                    creds_json = json.load(f)
                print(f"✓ Credentials loaded")
                print(f"  Service Account: {creds_json.get('client_email', 'MISSING')}")
                print(f"  Project ID: {creds_json.get('project_id', 'MISSING')}")
            except Exception as e:
                print(f"❌ Failed to load credentials: {e}")
                raise
            
            folder_id = os.environ.get('GDRIVE_FOLDER_ID', '')
            print(f"  Folder ID: {folder_id[:20]}..." if len(folder_id) > 20 else f"  Folder ID: {folder_id}")
            
            if not folder_id:
                print("❌ GDRIVE_FOLDER_ID is empty!")
                raise ValueError("Missing GDRIVE_FOLDER_ID")
            
            file_path = 'app/build/outputs/apk/debug/app-debug.apk'
            file_name = 'TraceBack-Debug.apk'
            
            if not os.path.exists(file_path):
                print(f"❌ File not found: {file_path}")
                raise FileNotFoundError(file_path)
            
            print(f"  File: {file_path} ({os.path.getsize(file_path)} bytes)")
            
            try:
                creds = service_account.Credentials.from_service_account_info(creds_json)
                print("✓ Credentials validated")
            except Exception as e:
                print(f"❌ Invalid credentials: {e}")
                raise
            
            try:
                drive = build('drive', 'v3', credentials=creds)
                print("✓ Drive API client created")
            except Exception as e:
                print(f"❌ Failed to create Drive client: {e}")
                raise

            for attempt in range(retries):
                try:
                    print(f"\n--- Attempt {attempt+1}/{retries} ---")
                    
                    # Test: List files in folder
                    print("Testing folder access...")
                    query = f"'{folder_id}' in parents and trashed = false"
                    results = drive.files().list(q=query, fields="files(id,name)", pageSize=5).execute()
                    existing = results.get('files', [])
                    print(f"✓ Folder accessible, {len(existing)} files found")
                    
                    # Check if our file exists
                    query = f"name = '{file_name}' and '{folder_id}' in parents and trashed = false"
                    results = drive.files().list(q=query, fields="files(id)").execute()
                    files = results.get('files', [])

                    media = MediaFileUpload(file_path, mimetype='application/vnd.android.package-archive', resumable=True)

                    if files:
                        print(f"Updating existing file (id: {files[0]['id']})...")
                        drive.files().update(fileId=files[0]['id'], media_body=media).execute()
                        print(f"✓ Updated: {file_name}")
                    else:
                        print("Creating new file...")
                        meta = {'name': file_name, 'parents': [folder_id]}
                        result = drive.files().create(body=meta, media_body=media, fields='id').execute()
                        print(f"✓ Created: {file_name} (id: {result['id']})")
                    return True
                    
                except HttpError as e:
                    print(f"❌ HTTP Error {e.status_code}: {e.reason}")
                    print(f"   Details: {e.error_details if hasattr(e, 'error_details') else 'none'}")
                    if attempt < retries - 1:
                        wait = 2 ** attempt
                        print(f"   Retrying in {wait}s...")
                        time.sleep(wait)
                    else:
                        raise
                except Exception as e:
                    print(f"❌ Error: {type(e).__name__}: {e}")
                    traceback.print_exc()
                    raise
            return False

        try:
            upload_to_drive()
            print("\n=== SUCCESS ===")
        except Exception as e:
            print(f"\n=== FAILED: {e} ===")
            sys.exit(1)
        PYEOF

    - name: Upload Drive debug log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gdrive-debug-log
        path: /tmp/gdrive-debug.log
        retention-days: 7

    - name: Upload Release APK to Google Drive
      if: env.HAVE_RELEASE_KEY == 'true'
      continue-on-error: true
      env:
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        python3 << 'PYEOF'
        import os, json, sys, time
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from googleapiclient.errors import HttpError
        from google.oauth2 import service_account

        def upload_file(file_path, file_name, retries=3):
            with open('/tmp/gdrive-creds.json', 'r') as f:
                creds_json = json.load(f)
            creds = service_account.Credentials.from_service_account_info(creds_json)
            drive = build('drive', 'v3', credentials=creds)
            folder_id = os.environ['GDRIVE_FOLDER_ID']
            
            for attempt in range(retries):
                try:
                    query = f"name = '{file_name}' and '{folder_id}' in parents and trashed = false"
                    results = drive.files().list(q=query, fields="files(id)").execute()
                    files = results.get('files', [])
                    media = MediaFileUpload(file_path, mimetype='application/vnd.android.package-archive', resumable=True)
                    if files:
                        drive.files().update(fileId=files[0]['id'], media_body=media).execute()
                        print(f"✓ Updated: {file_name}")
                    else:
                        meta = {'name': file_name, 'parents': [folder_id]}
                        drive.files().create(body=meta, media_body=media, fields='id').execute()
                        print(f"✓ Created: {file_name}")
                    return True
                except HttpError as e:
                    print(f"Attempt {attempt+1} failed: {e.status_code} - {e.reason}")
                    if attempt < retries - 1:
                        time.sleep(2 ** attempt)
                    else:
                        raise

        try:
            upload_file('app/build/outputs/apk/release/app-release.apk', 'TraceBack-Release.apk')
        except Exception as e:
            print(f"❌ Upload failed: {e}")
            sys.exit(1)
        PYEOF

    - name: Upload Release AAB to Google Drive
      if: env.HAVE_RELEASE_KEY == 'true'
      continue-on-error: true
      env:
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        python3 << 'PYEOF'
        import os, json, sys, time
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        from googleapiclient.errors import HttpError
        from google.oauth2 import service_account

        def upload_file(file_path, file_name, retries=3):
            with open('/tmp/gdrive-creds.json', 'r') as f:
                creds_json = json.load(f)
            creds = service_account.Credentials.from_service_account_info(creds_json)
            drive = build('drive', 'v3', credentials=creds)
            folder_id = os.environ['GDRIVE_FOLDER_ID']
            
            for attempt in range(retries):
                try:
                    query = f"name = '{file_name}' and '{folder_id}' in parents and trashed = false"
                    results = drive.files().list(q=query, fields="files(id)").execute()
                    files = results.get('files', [])
                    media = MediaFileUpload(file_path, mimetype='application/octet-stream', resumable=True)
                    if files:
                        drive.files().update(fileId=files[0]['id'], media_body=media).execute()
                        print(f"✓ Updated: {file_name}")
                    else:
                        meta = {'name': file_name, 'parents': [folder_id]}
                        drive.files().create(body=meta, media_body=media, fields='id').execute()
                        print(f"✓ Created: {file_name}")
                    return True
                except HttpError as e:
                    print(f"Attempt {attempt+1} failed: {e.status_code} - {e.reason}")
                    if attempt < retries - 1:
                        time.sleep(2 ** attempt)
                    else:
                        raise

        try:
            upload_file('app/build/outputs/bundle/release/app-release.aab', 'TraceBack-Release.aab')
        except Exception as e:
            print(f"❌ Upload failed: {e}")
            sys.exit(1)
        PYEOF

    - name: Cleanup credentials
      if: always()
      run: rm -f /tmp/gdrive-creds.json
